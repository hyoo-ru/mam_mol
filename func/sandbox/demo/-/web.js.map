{"version":3,"sources":["-","../../../../../mam.ts","../../../../../mol/dom/context/context.ts","../../../../../mol/dom/context/context.web.ts","../../../../../mol/func/sandbox/sandbox.ts"],"names":[],"mappings":"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","sourcesContent":[null,"Error.stackTraceLimit = 50;\n\ndeclare let _$_: { new(): {} } & typeof globalThis\ndeclare class $ extends _$_ {}\n\nnamespace $ {\n\texport type $ = typeof $$\n\texport declare class $$ extends $ {}\n\tnamespace $$ {\n\t\texport type $$ = $\n\t}\n}\n\nmodule.exports = $\n","namespace $ {\n\t\n\texport var $mol_dom_context : typeof globalThis\n\t\n}\n","namespace $ {\n\t\n\t$.$mol_dom_context = self as any\n\t\n}\n","namespace $ {\n\n\t/**\n\t * Sandbox for javascript code from user.\n\t * @see https://sandbox.js.hyoo.ru/\n\t */\n\texport class $mol_func_sandbox {\n\t\t\n\t\tstatic blacklist = new Set([\n\t\t\t( function() {} ).constructor ,\n\t\t\t( async function() {} ).constructor ,\n\t\t\t( function*() {} ).constructor ,\n\t\t\t( async function*() {} ).constructor ,\n\t\t\teval ,\n\t\t\tsetTimeout ,\n\t\t\tsetInterval ,\n\t\t])\n\n\t\tstatic whitelist = new WeakSet()\n\n\t\tstatic _make : ( contexts : Object[] )=> ( code : string )=> ()=> any\n\n\t\tstatic get make() {\n\n\t\t\tif( this._make ) return this._make\n\t\t\t\n\t\t\tconst frame = $mol_dom_context.document.createElement( 'iframe' )\n\n\t\t\tframe.style.display = 'none'\n\t\t\t$mol_dom_context.document.body.appendChild( frame )\n\n\t\t\tconst win = frame.contentWindow as any as typeof globalThis\n\t\t\tconst SafeFunc = win.Function\n\t\t\tconst SafeJSON = win.JSON\n\t\t\t\n\t\t\twin.eval( `\n\n\t\t\t\tvar AsyncFunction = AsyncFunction || ( async function() {} ).constructor\n\t\t\t\tvar GeneratorFunction = GeneratorFunction || ( function*() {} ).constructor\n\t\t\t\tvar AsyncGeneratorFunction = AsyncGeneratorFunction || ( async function*() {} ).constructor\n\n\t\t\t\tObject.defineProperty( Function.prototype , 'constructor' , { value : undefined } )\n\t\t\t\tObject.defineProperty( AsyncFunction.prototype , 'constructor' , { value : undefined } )\n\t\t\t\tObject.defineProperty( GeneratorFunction.prototype , 'constructor' , { value : undefined } )\n\t\t\t\tObject.defineProperty( AsyncGeneratorFunction.prototype , 'constructor' , { value : undefined } )\n\t\t\t\t\n\t\t\t\tdelete Object.prototype.__proto__\n\n\t\t\t\tfor( const Class of [\n\t\t\t\t\tString , Number , BigInt , Boolean , Array , Object , Promise , Symbol , RegExp , \n\t\t\t\t\tWindow, Error , RangeError , ReferenceError , SyntaxError , TypeError ,\n\t\t\t\t\tFunction , AsyncFunction , GeneratorFunction , AsyncGeneratorFunction\n\t\t\t\t] ) {\n\t\t\t\t\tObject.freeze( Class )\n\t\t\t\t\tObject.freeze( Class.prototype )\n\t\t\t\t}\n\n\t\t\t\tfor( const key of Object.getOwnPropertyNames( window ) ) delete window[ key ]\n\n\t\t\t` )\n\n\t\t\t// Stop event-loop and break all async operations\n\t\t\t$mol_dom_context.document.body.removeChild( frame )\n\t\t\t\n\t\t\tlet context_default = {} as Record< string, any >\n\n\t\t\tfunction clean( obj : object ) {\n\n\t\t\t\tfor( let name of Object.getOwnPropertyNames( obj ) ) {\n\t\t\t\t\tcontext_default[ name ] = undefined\n\t\t\t\t}\n\t\t\t\t\n\t\t\t\tconst proto = Object.getPrototypeOf( obj )\n\t\t\t\tif( proto ) clean( proto )\n\n\t\t\t}\n\t\t\tclean( win )\n\n\t\t\tconst is_primitive = ( val : any )=> Object( val ) !== val\n\n\t\t\tconst safe_value = ( val : any ) : any => {\n\n\t\t\t\tif( is_primitive( val ) ) return val\n\t\t\t\tif( this.blacklist.has( val ) ) return undefined\n\t\t\t\tif( this.whitelist.has( val ) ) return val\n\t\t\t\t\n\t\t\t\tconst str = JSON.stringify( val )\n\t\t\t\tif( !str ) return str\n\n\t\t\t\tval = SafeJSON.parse( str )\n\t\t\t\tthis.whitelist.add( val )\n\t\t\t\treturn val\n\n\t\t\t}\n\n\t\t\tconst safe_derived = ( val : any ) : any => {\n\t\t\t\t\n\t\t\t\tif( is_primitive( val ) ) return val\n\t\t\t\t\n\t\t\t\tconst proxy = new Proxy( val , {\n\n\t\t\t\t\tget( val , field : any ) {\n\t\t\t\t\t\tif( field === 'valueOf' ) return safe_derived( val[field] )\n\t\t\t\t\t\tif( field === 'toString' ) return safe_derived( val[field] )\n\t\t\t\t\t\treturn safe_value( val[field] )\n\t\t\t\t\t},\n\t\t\t\t\t\n\t\t\t\t\tset() { return false },\n\t\t\t\t\tdefineProperty() { return false },\n\t\t\t\t\tdeleteProperty() { return false },\n\t\t\t\t\tpreventExtensions() { return false },\n\t\t\t\t\t\n\t\t\t\t\tapply( val , host , args ) {\n\t\t\t\t\t\treturn safe_value( val.call( host , ... args ) )\n\t\t\t\t\t},\n\n\t\t\t\t\tconstruct( val , args ) {\n\t\t\t\t\t\treturn safe_value( new val( ... args ) )\n\t\t\t\t\t},\n\n\t\t\t\t})\n\n\t\t\t\tthis.whitelist.add( proxy )\n\n\t\t\t\treturn proxy\n\t\t\t}\n\n\t\t\treturn this._make = ( ( ... contexts : Record< string, any >[] )=> {\n\n\t\t\t\tconst context_merged = {} as Record< string, any >\n\n\t\t\t\tfor( let context of contexts ) {\n\t\t\t\t\tfor( let name of Object.getOwnPropertyNames( context ) ) {\n\t\t\t\t\t\tcontext_merged[ name ] = safe_derived( context[ name ] )\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\tconst vars = Object.keys( context_merged )\n\t\t\t\tconst values = vars.map( name => context_merged[ name ] )\n\t\n\t\t\t\treturn ( code : string )=> {\n\n\t\t\t\t\tconst func = new SafeFunc( ... vars , '\"use strict\";' + code )\n\t\t\t\t\t\t.bind( null , ... values )\n\t\t\t\t\t\n\t\t\t\t\treturn ()=> {\n\n\t\t\t\t\t\tconst val = func()\n\t\t\t\t\t\tif( is_primitive( val ) ) return val\n\t\t\t\t\t\t\n\t\t\t\t\t\tthis.whitelist.add( val )\n\n\t\t\t\t\t\treturn val\n\t\t\t\t\t}\n\n\t\t\t\t}\n\n\t\t\t} ).bind( null , context_default )\n\n\t\t}\n\n\t\tconstructor( ... contexts : Object[] ) {\n\t\t\tthis.contexts = contexts\n\t\t}\n\n\t\tcontexts : Object[]\n\t\t\n\t\t_eval : ( ( code : string )=> ()=> any ) | undefined\n\t\tget eval() {\n\t\t\tif( this._eval ) return this._eval\n\t\t\treturn this._eval = $mol_func_sandbox.make( ... this.contexts as [Object[]] )\n\t\t}\n\n\t}\n\n}\n"]}